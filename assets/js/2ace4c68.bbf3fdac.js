"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6105],{1090:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var o=t(4848),r=t(8453);const i={sidebar_position:3,title:"03 - Infrastructure"},s="Terraform",l={id:"rad-lab-ui/ui_installation/infrastructure",title:"03 - Infrastructure",description:"The radlab-ui/automation/terraform/infrastructure folder contains the needed Terraform scripts to set up Google Cloud",source:"@site/docs/rad-lab-ui/ui_installation/infrastructure.md",sourceDirName:"rad-lab-ui/ui_installation",slug:"/rad-lab-ui/ui_installation/infrastructure",permalink:"/rad-lab/docs/rad-lab-ui/ui_installation/infrastructure",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"03 - Infrastructure"},sidebar:"tutorialSidebar",previous:{title:"02 - Google Cloud",permalink:"/rad-lab/docs/rad-lab-ui/ui_installation/setup-gcp"},next:{title:"04 - Web Application",permalink:"/rad-lab/docs/rad-lab-ui/ui_installation/frontend"}},a={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"IAM Permissions",id:"iam-permissions",level:3},{value:"Billing",id:"billing",level:4},{value:"Tools",id:"tools",level:3},{value:"Infrastructure",id:"infrastructure",level:2},{value:"Variable Values",id:"variable-values",level:3},{value:"Initial Run",id:"initial-run",level:3},{value:"Github Personal Access Token",id:"github-personal-access-token",level:3},{value:"Connect Repository",id:"connect-repository",level:3},{value:"Admin API",id:"admin-api",level:3},{value:"Billing",id:"billing-1",level:2},{value:"Steps",id:"steps",level:3},{value:"Organization Policies",id:"organization-policies",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"terraform",children:"Terraform"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"radlab-ui/automation/terraform/infrastructure"})," folder contains the needed Terraform scripts to set up Google Cloud\nnecessary to run the RAD Lab UI. Make sure to run all the commands and steps listed here in that folder, unless\nindicated otherwise."]}),"\n",(0,o.jsx)(n.admonition,{title:"Important",type:"danger",children:(0,o.jsxs)(n.p,{children:["Ensure ",(0,o.jsx)(n.a,{href:"../source-control",children:"01 - Source Control"})," and ",(0,o.jsx)(n.a,{href:"../setup-gcp",children:"02 - Google Cloud"})," steps are complete before\nproceeding"]})}),"\n",(0,o.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsx)(n.p,{children:"The following prerequisites have to be met in order to proceed with the Terraform installation."}),"\n",(0,o.jsx)(n.h3,{id:"iam-permissions",children:"IAM Permissions"}),"\n",(0,o.jsx)(n.p,{children:"The identity running the Terraform scripts requires the following permissions at Folder-level, on the Folder where you will create the RAD Lab UI project."}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Project\nCreator (",(0,o.jsx)(n.a,{href:"https://cloud.google.com/resource-manager/docs/access-control-proj#using_predefined_roles",children:(0,o.jsx)(n.code,{children:"roles/resourcemanager.projectCreator"})}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Folder IAM\nAdmin (",(0,o.jsx)(n.a,{href:"https://cloud.google.com/resource-manager/docs/access-control-folders#FolderRolesAndPermissions",children:(0,o.jsx)(n.code,{children:"roles/resourcemanager.folderIamAdmin"})}),")"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This will ensure that the RAD Lab UI project can be created and that the service accounts can be\nassigned the correct IAM permissions to create the projects (as configured by the RAD Lab modules)."}),"\n",(0,o.jsx)(n.h4,{id:"billing",children:"Billing"}),"\n",(0,o.jsxs)(n.p,{children:["By default, during the installation of the RAD Lab UI, Billing IAM permissions for service accounts have to be set\nmanually. A Service Account will be created that will orchestrate the creation of Google Cloud projects as part of the\nRAD Lab modules. This services\nrequires ",(0,o.jsx)(n.a,{href:"https://cloud.google.com/billing/docs/how-to/billing-access#overview-of-cloud-billing-roles-in-cloud-iam",children:"Billing User permissions"}),"\nto link newly created Google Cloud projects to the Billing Account ID."]}),"\n",(0,o.jsxs)(n.p,{children:["If the identity running the RAD Lab UI installation\nhas ",(0,o.jsx)(n.a,{href:"https://cloud.google.com/billing/docs/how-to/billing-access#overview-of-cloud-billing-roles-in-cloud-iam",children:"Billing Admin permission"}),"\n, you can set ",(0,o.jsx)(n.code,{children:"set_billing_permissions"})," to ",(0,o.jsx)(n.code,{children:"true"})," in your ",(0,o.jsx)(n.code,{children:"terraform.tfvars"})," (more on that later)."]}),"\n",(0,o.jsx)(n.h3,{id:"tools",children:"Tools"}),"\n",(0,o.jsx)(n.p,{children:"When installing the RAD Lab UI, a number of tools are required to complete all the steps:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://cloud.google.com/sdk/docs/install",children:(0,o.jsx)(n.code,{children:"gcloud"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.npmjs.com/downloading-and-installing-node-js-and-npm",children:(0,o.jsx)(n.code,{children:"npm"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://firebase.google.com/docs/cli",children:(0,o.jsx)(n.code,{children:"firebase-tools"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://learn.hashicorp.com/tutorials/terraform/install-cli",children:(0,o.jsx)(n.code,{children:"terraform"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://stedolan.github.io/jq/download/",children:(0,o.jsx)(n.code,{children:"jq"})})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"infrastructure",children:"Infrastructure"}),"\n",(0,o.jsx)(n.h3,{id:"variable-values",children:"Variable Values"}),"\n",(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.code,{children:"radlab-ui/automation/terraform/infrastructure"})," folder, create a ",(0,o.jsx)(n.code,{children:"terraform.tfvars"})," file with, at minimum, the\nfollowing values (replace the dummy values with the actual values for your organization):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'cd radlab-ui/automation/terraform/infrastructure\n\ncat <<EOT > terraform.tfvars\nbilling_account_id  = "ABCD12-ABCD12-ABCD12"\nparent              = "folders/123456789"\norganization_name   = "your-organization-domain"\ngit_repo_url        = "your-repo-url"\nEOT\n'})}),"\n",(0,o.jsxs)(n.p,{children:["As mentioned earlier, if you want to create the Billing IAM permissions for the RAD Lab modules service account\nautomatically, set ",(0,o.jsx)(n.code,{children:"set_billing_permissions"})," to ",(0,o.jsx)(n.code,{children:"true"})," in the ",(0,o.jsx)(n.code,{children:"terraform.tfvars"}),"-file."]}),"\n",(0,o.jsxs)(n.p,{children:["For an overview of which variables can be overridden, please refer to the module's ",(0,o.jsx)(n.code,{children:"variables.tf"})," file. By default, it\nwill point to the standard public ",(0,o.jsx)(n.a,{href:"https://github.com/GoogleCloudPlatform/rad-lab",children:"Git repository"})," for the rad-lab\nmodules. If you forked the repo and are hosting your own, make sure that the variable ",(0,o.jsx)(n.code,{children:"git_repo_url"})," is set."]}),"\n",(0,o.jsxs)(n.p,{children:["If you want to override other variables, simply add the variable name and the required value to the ",(0,o.jsx)(n.code,{children:"terraform.tfvars"}),"\nfile."]}),"\n",(0,o.jsx)(n.h3,{id:"initial-run",children:"Initial Run"}),"\n",(0,o.jsxs)(n.p,{children:["Run the following commands in a terminal or command window. You can also run this via a CI/CD pipeline if necessary, as\nlong as the Service Account has the required IAM permissions as described ",(0,o.jsx)(n.a,{href:"#iam-permissions",children:"here"}),"."]}),"\n",(0,o.jsx)(n.admonition,{title:"IMPORTANT",type:"warning",children:(0,o.jsxs)(n.p,{children:["If you receive an error while running ",(0,o.jsx)(n.code,{children:"terraform apply"})," in the next section, run ",(0,o.jsx)(n.code,{children:"terraform init -migrate-state"})," before running ",(0,o.jsx)(n.code,{children:"terraform apply -auto-approve"}),"."]})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"# Setting up GCP Auth\ngcloud auth application-default login\ngcloud auth login\n\n# Initialise the Terraform modules and providers\nterraform init -upgrade\n\n# Run Terraform plan and validate the output\nterraform plan -out radlab-ui.out\n\n# Create the resources\nterraform apply \"radlab-ui.out\"\n\n# Init the directory again, as this is required to\n#   copy the local state to the newly created storage bucket.\n# When prompted, type in 'yes' to copy the local state remotely\nterraform init -migrate-state\n\n# Remove the output of the `terraform plan` step\nrm radlab-ui.out\n\n# Export PROJECT_ID as environment variable\nexport PROJECT_ID=$(terraform output -json | jq -r .project_id.value)\n\n# Update your local gcloud config to point to the new project\ngcloud config set project ${PROJECT_ID}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The reason why you need to run ",(0,o.jsx)(n.code,{children:"terraform init"})," twice is that the Terraform code will create a file (",(0,o.jsx)(n.code,{children:"backend.tf"}),") with\na ",(0,o.jsx)(n.code,{children:"terraform {}"})," resource, that points to a newly created bucket in the RAD Lab UI project. This will allow you to store\nthe state remotely and collaborate on any future changes with other developers."]}),"\n",(0,o.jsxs)(n.p,{children:["It's important to point out that ",(0,o.jsx)(n.code,{children:"terraform.tfvars"})," contains sensitive information. It's up to you to decide whether you want to store this in Github. If that is not the case, simply don't add that file."]}),"\n",(0,o.jsx)(n.h3,{id:"github-personal-access-token",children:"Github Personal Access Token"}),"\n",(0,o.jsxs)(n.p,{children:["To establish a connection between Google App Engine and your Github private repository, you need to generate\na ",(0,o.jsx)(n.a,{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",children:"Github Personal Access Token"}),"\nand pass it to Google Cloud's Secret Manager using a ",(0,o.jsx)(n.code,{children:"gcloud"})," command. App Engine can then securely use the secret (Github\nPersonal Access Token) to fetch the RAD Lab modules from your repo."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["To generate the access token, go to ",(0,o.jsx)(n.a,{href:"https://github.com",children:"Github.com"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Click on your user profile in the top corner and open Settings"}),"\n",(0,o.jsxs)(n.li,{children:["Scroll all the way to the bottom and click on ",(0,o.jsx)(n.code,{children:"</> Developer Settings"})]}),"\n",(0,o.jsxs)(n.li,{children:["In the ",(0,o.jsx)(n.strong,{children:"Personal accesss tokens"}),"-section, click on ",(0,o.jsx)(n.strong,{children:"Generate new token"}),", underneath ",(0,o.jsx)(n.strong,{children:"Fine-grained tokens"})]}),"\n",(0,o.jsxs)(n.li,{children:["Enter the following details","\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Token name: Give it a meaningful name (e.g. ",(0,o.jsx)(n.code,{children:"rad-lab-ui"}),")"]}),"\n",(0,o.jsx)(n.li,{children:"Set the expiration date (No expiration is more convenient, but setting a fixed expiration will be more secure)"}),"\n",(0,o.jsxs)(n.li,{children:["Underneath ",(0,o.jsx)(n.strong,{children:"Repository access"}),", select ",(0,o.jsx)(n.strong,{children:"Only select repositories"})," and select the repository where you store the RAD Lab UI code"]}),"\n",(0,o.jsxs)(n.li,{children:["For ",(0,o.jsx)(n.strong,{children:"Contents"})," (underneath ",(0,o.jsx)(n.strong,{children:"Permissions"}),"), select ",(0,o.jsx)(n.strong,{children:"Read-Only"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"Generate token"})]}),"\n",(0,o.jsx)(n.li,{children:"Copy the value of the token."}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["You can add a secret directly on the command line using below command (replace ",(0,o.jsx)(n.code,{children:"${GIT_PERSONAL_ACCESS_TOKEN}"})," with the token copied from the Github UI), where ",(0,o.jsx)(n.code,{children:"${PROJECT_ID}"})," corresponds to the RAD Lab UI project ID."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'echo -n "${GIT_PERSONAL_ACCESS_TOKEN}" | \\\n    gcloud secrets versions add $(terraform output -json | jq -r .git_personal_access_token_secret_id.value) --data-file=- --project ${PROJECT_ID}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"connect-repository",children:"Connect Repository"}),"\n",(0,o.jsx)(n.admonition,{title:"NOTE",type:"info",children:(0,o.jsxs)(n.p,{children:["Make sure to ",(0,o.jsx)(n.strong,{children:"manually"})," connect your forked RAD Lab repo before start deploying the RAD Lab modules."]})}),"\n",(0,o.jsx)(n.p,{children:"To be able to retrieve the list of available modules, variables and deployment files, Cloud Build requires access to\nyour repository. This is a step that only has to be executed once."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Open the ",(0,o.jsx)(n.a,{href:"https://console.cloud.google.com",children:"Google Cloud console"})]}),"\n",(0,o.jsx)(n.li,{children:"Navigate to Cloud Build in the newly created project."}),"\n",(0,o.jsxs)(n.li,{children:["Go to the Cloud Build > ",(0,o.jsx)(n.a,{href:"https://console.cloud.google.com/cloud-build/triggers",children:"Triggers"})]}),"\n",(0,o.jsxs)(n.li,{children:["click on ",(0,o.jsx)(n.strong,{children:"Connect Repository"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Follow the necessary steps to connect your repository to the Google Cloud project."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"There is no need to create a trigger in this step, as this has already been done by Terraform."}),"\n",(0,o.jsx)(n.h3,{id:"admin-api",children:"Admin API"}),"\n",(0,o.jsx)(n.admonition,{title:"Super Admin privileges",type:"danger",children:(0,o.jsx)(n.p,{children:"The identity that executes this step requires Super Admin permissions. There is no way around this, as\nthis is how the IAM permissions work for Cloud Identity."})}),"\n",(0,o.jsx)(n.p,{children:"For the web application to validate group membership, a manual step is required to add the service account to the\ncorrect group. To retrieve the correct service account name, go back to the command line and run the following command.  Copy the output to the clipboard."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'echo "$(terraform show -json | jq -r .values.outputs.webapp_identity_email.value)"\n'})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Go to ",(0,o.jsx)(n.a,{href:"https://admin.google.com",children:"https://admin.google.com"})]}),"\n",(0,o.jsxs)(n.li,{children:["Go to the section to manage ",(0,o.jsx)(n.a,{href:"https://admin.google.com/ac/roles",children:"roles & permissions"})]}),"\n",(0,o.jsxs)(n.li,{children:["Click on the role ",(0,o.jsx)(n.strong,{children:"Groups Reader"}),", which is currently in ",(0,o.jsx)(n.em,{children:"BETA"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"Assign Role"})]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"Assign service accounts"})," and paste the value from the terminal, copied at the start of this section."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"billing-1",children:"Billing"}),"\n",(0,o.jsx)(n.admonition,{title:"IAM Permissions",type:"info",children:(0,o.jsxs)(n.p,{children:["In order to complete this section, the user executing these steps should have the ",(0,o.jsx)(n.strong,{children:"Billing Account Admin"})," role on either the Billing Account or the Google Cloud organization that is linked to the Billing Account."]})}),"\n",(0,o.jsx)(n.p,{children:"If you are manually creating the Billing IAM permissions, execute the following steps so the RAD Lab deployment service account can link projects to the billing account.  Make note of the identity name by running the following command."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"# Retrieve the RAD Lab deployment identity\nterraform output -json | jq -r .service_account_module_creator.value\n"})}),"\n",(0,o.jsx)(n.h3,{id:"steps",children:"Steps"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Open the ",(0,o.jsx)(n.a,{href:"https://console.cloud.google.com",children:"Google Cloud console"})]}),"\n",(0,o.jsx)(n.li,{children:"Go to Billing > Manage Billing Accounts"}),"\n",(0,o.jsx)(n.li,{children:"Select the Billing Account that you want to use for the RAD Lab deployments"}),"\n",(0,o.jsxs)(n.li,{children:["Select ",(0,o.jsx)(n.strong,{children:"Account Management"})," in the menu"]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.code,{children:"Show Info Panel"})," in the top right corner, if it's not already showing"]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"Add Principal"})]}),"\n",(0,o.jsx)(n.li,{children:"In the text field, add the service account ID that you copied from the terminal at the start of this section"}),"\n",(0,o.jsxs)(n.li,{children:["In ",(0,o.jsx)(n.strong,{children:"Role"}),", select ",(0,o.jsx)(n.code,{children:"Billing Account User"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"+ Add Another Role"})," and select ",(0,o.jsx)(n.code,{children:"Billing Account Costs Manager"})]}),"\n",(0,o.jsxs)(n.li,{children:["Click ",(0,o.jsx)(n.strong,{children:"Save"})]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"organization-policies",children:"Organization Policies"}),"\n",(0,o.jsxs)(n.p,{children:["Some modules may require changes to organization policies.  This is why we recommend to install the RAD Lab UI in a different folder than the rest of the organization.  You can either set those exceptions at Folder-level, or you can let the UI manage them for you.  If that's the case, you have to grant the service account of the UI the IAM role ",(0,o.jsx)(n.code,{children:"roles/orgpolicy.policyAdmin"})," at ",(0,o.jsx)(n.strong,{children:"organization"}),"-level."]}),"\n",(0,o.jsx)(n.p,{children:"Retrieve the ID of the service account by running the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"# Retrieve the RAD Lab deployment identity\nterraform output -json | jq -r .service_account_module_creator.value\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Go back to the ",(0,o.jsx)(n.a,{href:"https://console.cloud.google.com",children:"Google Cloud console"})," and make sure that you select the ",(0,o.jsx)(n.strong,{children:"organization"})," at the top of the section."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Open the menu and go to ",(0,o.jsx)(n.strong,{children:"IAM & Admin"})," > ",(0,o.jsx)(n.strong,{children:"IAM"})]}),"\n",(0,o.jsxs)(n.li,{children:["Click on ",(0,o.jsx)(n.strong,{children:"Grant Access"})]}),"\n",(0,o.jsxs)(n.li,{children:["In the section ",(0,o.jsx)(n.strong,{children:"Add principals"}),", paste the ID of the service account copied in the previous step.  In ",(0,o.jsx)(n.strong,{children:"Assign roles"}),", select ",(0,o.jsx)(n.strong,{children:"Organization Policy Administrator"})]}),"\n",(0,o.jsxs)(n.li,{children:["Click ",(0,o.jsx)(n.strong,{children:"Save"})]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Make sure to select the RAD Lab UI project after this step in the UI."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>l});var o=t(6540);const r={},i=o.createContext(r);function s(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);